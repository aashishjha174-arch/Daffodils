<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Daffodils Public School | Reviews</title>
<link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Montserrat:wght@300;600&family=Playfair+Display:ital,wght@0,700;1,400&display=swap" rel="stylesheet">
<link rel="icon" href="images/logo.webp">
<style>
:root{
  --glass: rgba(255,255,255,0.1);
  --gold:#d4af37;
  --text:#fff;
  --nav-color:#c2f3f3;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:#000;color:var(--text);font-family:'Montserrat',sans-serif;overflow-x:hidden;}
#bg-container{position:fixed;inset:0;z-index:-2;}
.bg-slide{position:absolute;inset:-20px;background-size:cover;background-position:center;opacity:0;filter:blur(20px) brightness(0.4) saturate(1.2);transition:opacity 2s;}
.bg-slide.active{opacity:1}
#particles{position:fixed;inset:0;z-index:-1;pointer-events:none}
.particle{position:absolute;width:4px;height:4px;background:white;border-radius:50%;opacity:.4;animation:floatUp 15s infinite linear}
@keyframes floatUp{0%{transform:translateY(110vh);opacity:0}50%{opacity:.5}100%{transform:translateY(-10vh);opacity:0}}

header{
  text-align:center;
  padding:60px 20px 20px;
}

.title-container{
  display:flex;
  justify-content:center;
  align-items:center;
  gap:20px;
  flex-wrap:wrap;
}

.school-name{
  font-family:'Playfair Display',serif;
  font-size:clamp(2rem, 6vw, 3.5rem);
  color:var(--gold);
  line-height: 1.2;
}

.school-logo{
  height:clamp(60px, 10vw, 80px);
  border-radius:50%;
  filter:drop-shadow(0 0 10px rgba(212,175,55,.5));
}

header p {
  letter-spacing:clamp(2px, 1vw, 5px);
  opacity:.8;
  font-size:clamp(0.7rem, 2vw, 1rem);
  margin-top: 10px;
}

.nav-bar{
  display:flex;
  justify-content:center;
  gap:20px;
  flex-wrap:wrap;
  padding:10px 20px;
  background:rgba(0,0,0,.6);
  backdrop-filter:blur(10px);
  position:sticky;
  top:0;
  z-index:999;
}

.nav-bar a{
  color:var(--nav-color);
  text-decoration:none;
  font-weight:bold;
  padding:8px 15px;
  border-radius:20px;
  border:1px solid var(--nav-color);
  transition:.3s;
  font-size:clamp(0.8rem, 2vw, 1rem);
}

.nav-bar a:hover{
  background:var(--nav-color);
  color:#000;
}

main{
  max-width:1200px;
  margin:40px auto;
  padding:20px;
  text-align:center;
}

h2{
  color:var(--gold);
  font-family:'Playfair Display',serif;
  margin-bottom:15px;
  font-size:clamp(1.5rem, 4vw, 2rem);
}

.review-form{
  max-width:600px;
  margin:auto;
  display:flex;
  flex-direction:column;
  gap:15px;
}

.review-form textarea{
  padding:12px 15px;
  border-radius:20px;
  border:1px solid rgba(255,255,255,.2);
  background:rgba(0,0,0,.6);
  color:white;
  outline:none;
  font-family:inherit;
  font-size:clamp(0.9rem, 2vw, 1rem);
}

.review-form button{
  background:var(--gold);
  border:none;
  padding:12px;
  border-radius:30px;
  cursor:pointer;
  font-weight:bold;
  font-size:clamp(0.9rem, 2vw, 1rem);
}

#reviews{
  margin-top:40px;
  display:grid;
  gap:20px;
  text-align:left;
}

.review-card{
  background:var(--glass);
  border:1px solid rgba(255,255,255,.15);
  border-radius:20px;
  padding:20px;
  position:relative;
  backdrop-filter:blur(10px);
}

.review-card h3{
  color:var(--gold);
  margin-bottom:5px;
  font-size:clamp(1rem, 3vw, 1.2rem);
  padding-right: 60px;
}

.review-time{
  font-size:clamp(0.7rem, 2vw, 0.8rem);
  opacity:.7;
  margin-bottom:10px;
}

.review-card p{
  font-size:clamp(0.9rem, 2vw, 1rem);
}

.delete-review, .report-review{
  position:absolute;
  top:15px;
  cursor:pointer;
  font-size:clamp(0.9rem, 2vw, 1rem);
  opacity:.7;
}

.delete-review{
  right:20px;
  color:#ff4444;
}

.report-review{
  right:80px;
  color:#ff6666;
}

.delete-review:hover, .report-review:hover{
  opacity:1;
}

.replies{
  margin-top:15px;
  padding-left:20px;
  border-left:1px solid rgba(255,255,255,.2);
}

.reply-card{
  margin-bottom:10px;
}

.reply-card h4{
  color:var(--gold);
  font-size:clamp(0.8rem, 2vw, 0.9rem);
  margin-bottom:3px;
}

.reply-card p{
  margin:0;
  font-size:clamp(0.8rem, 2vw, 0.9rem);
}

.reply-form{
  display:flex;
  gap:10px;
  margin-top:5px;
  flex-wrap:wrap;
}

.reply-form textarea{
  flex:1;
  min-width:200px;
  border-radius:15px;
  padding:8px 12px;
  font-size:clamp(0.8rem, 2vw, 0.9rem);
  background:rgba(0,0,0,.6);
  color:white;
  border:1px solid rgba(255,255,255,.2);
  outline:none;
  font-family:inherit;
}

.reply-form button{
  padding:8px 15px;
  border-radius:15px;
  background:var(--gold);
  border:none;
  color:#000;
  cursor:pointer;
  font-weight:bold;
  font-size:clamp(0.8rem, 2vw, 0.9rem);
}

#tab-buttons{
  display:flex;
  justify-content:center;
  gap:20px;
  margin-bottom:20px;
  flex-wrap:wrap;
}

#tab-buttons button{
  padding:10px 20px;
  cursor:pointer;
  background:rgba(255,255,255,0.1);
  border:none;
  color:white;
  border-radius:20px;
  transition:.3s;
  font-size:clamp(0.9rem, 2vw, 1rem);
}

#tab-buttons button.active{
  background:var(--gold);
  color:#000;
}

.success-message{
  color:limegreen;
  text-align:center;
  margin-top:10px;
  font-size:clamp(0.9rem, 2vw, 1rem);
}

.report-message{
  color: #ffaa00;
  text-align: center;
  margin-top: 5px;
  font-size: clamp(0.8rem, 2vw, 0.9rem);
  background: rgba(0,0,0,0.5);
  padding: 5px 10px;
  border-radius: 20px;
  display: inline-block;
}

/* Mobile optimizations */
@media (max-width: 768px) {
  header { padding: 40px 15px 15px; }
  .title-container { gap: 15px; }
  main { padding: 15px; margin: 20px auto; }
  .nav-bar { gap: 10px; padding: 10px 15px; }
  .review-card { padding: 15px; }
  .replies { padding-left: 15px; }
  .delete-review, .report-review { top:10px; font-size:0.8rem; }
  .report-review { right:60px; }
}

@media (max-width: 480px) {
  .title-container { flex-direction: column; gap: 10px; }
  .school-name { text-align: center; }
  header p { font-size: 0.7rem; letter-spacing: 2px; }
}
</style>
</head>
<body>

<div id="bg-container"></div>
<div id="particles"></div>

<header>
  <div class="title-container">
    <h1 class="school-name">DAFFODILS PUBLIC SCHOOL</h1>
    <img src="images/logo.webp" class="school-logo">
  </div>
  <p>THE FINAL FAREWELL • BATCH 2082</p>
</header>

<div class="nav-bar">
  <a href="student.html">Batch Members</a>
  <a href="dashboard.html">Dashboard</a>
  <a href="review.html">Review</a>
  <a href="ourmemories.html">Our Memories</a>
  <a href="backbone.html">Backbones</a>
</div>

<main>
  <h2>Reviews</h2>

  <div id="tab-buttons">
    <button id="tab-create" class="active">Create Review</button>
    <button id="tab-all">All Reviews</button>
  </div>

  <div id="tab-content">
    <div id="create-review">
      <form class="review-form" id="reviewForm">
        <textarea placeholder="Write your review..." rows="5" required></textarea>
        <button type="submit">Submit Review</button>
      </form>
      <div id="successMsg" class="success-message"></div>
    </div>

    <div id="all-reviews" style="display:none;">
      <div id="reviews"></div>
    </div>
  </div>
</main>

<script>
const API_URL = "http://localhost:3000/reviews"; // local testing
// const API_URL = "https://daffodils-j973.onrender.com/reviews"; // production

const token = localStorage.getItem('token');
const currentUser = localStorage.getItem('currentUser') || "Guest";

const form = document.getElementById("reviewForm");
const box = document.getElementById("reviews");
const tabCreate = document.getElementById("tab-create");
const tabAll = document.getElementById("tab-all");
const createDiv = document.getElementById("create-review");
const allDiv = document.getElementById("all-reviews");
const successMsg = document.getElementById("successMsg");

// Background slideshow
const bgImages = ['images/bg.webp','images/bg2.webp','images/bg3.webp', 'images/sample2.webp'];
function setupBackgrounds(){
    const container = document.getElementById('bg-container');
    container.innerHTML='';
    bgImages.forEach((img,index)=>{
        const div=document.createElement('div');
        div.className=`bg-slide ${index===0?'active':''}`;
        div.style.backgroundImage=`url('${img}')`;
        container.appendChild(div);
    });
    let current=0;
    setInterval(()=>{
        const slides=document.querySelectorAll('.bg-slide');
        slides[current].classList.remove('active');
        current=(current+1)%slides.length;
        slides[current].classList.add('active');
    },6000);
}
setupBackgrounds();

// Particles
function createParticles(){
    const container=document.getElementById('particles');
    for(let i=0;i<40;i++){
        const p=document.createElement('div');
        p.className='particle';
        const size=Math.random()*4+2;
        p.style.width=`${size}px`;
        p.style.height=`${size}px`;
        p.style.left=Math.random()*100+'vw';
        p.style.animationDuration=(Math.random()*10+8)+'s';
        p.style.animationDelay=(Math.random()*5)+'s';
        container.appendChild(p);
    }
}
createParticles();

// Function to show temporary message
function showTemporaryMessage(element, message, duration = 3000) {
  const msgDiv = document.createElement('div');
  msgDiv.className = 'report-message';
  msgDiv.textContent = message;
  msgDiv.style.position = 'fixed';
  msgDiv.style.top = '20px';
  msgDiv.style.left = '50%';
  msgDiv.style.transform = 'translateX(-50%)';
  msgDiv.style.zIndex = '10000';
  msgDiv.style.backgroundColor = 'rgba(212, 175, 55, 0.9)';
  msgDiv.style.color = '#000';
  msgDiv.style.padding = '12px 24px';
  msgDiv.style.borderRadius = '30px';
  msgDiv.style.fontWeight = 'bold';
  msgDiv.style.boxShadow = '0 4px 15px rgba(0,0,0,0.3)';
  document.body.appendChild(msgDiv);
  
  setTimeout(() => {
    msgDiv.remove();
  }, duration);
}

// Submit Review
form.addEventListener("submit", async e => {
  e.preventDefault();
  const message = form.querySelector("textarea").value.trim();
  if(!message) return alert("Please write something");

  if (!token) {
    alert("Please log in first to post a review.");
    return;
  }

  try {
    const res = await fetch(API_URL, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${token}`
      },
      body: JSON.stringify({ message })
    });

    const data = await res.json();

    if (!data.success) {
      if (res.status === 401) {
        alert("Session expired or unauthorized. Please log in again.");
      } else if (data.message === "blocked_toxic") {
        // Show gold warning modal
        const modal = document.createElement('div');
        modal.style.cssText = 'position:fixed; inset:0; background:rgba(0,0,0,0.75); z-index:9999; display:flex; justify-content:center; align-items:center;';
        modal.innerHTML = `
          <div style="background:rgba(30,30,50,0.95); border:2px solid #d4af37; border-radius:20px; padding:40px; max-width:520px; text-align:center; color:#fff; font-family:'Playfair Display',serif; box-shadow:0 0 30px rgba(212,175,55,0.3);">
            <h2 style="color:#d4af37; margin-bottom:25px; font-size:1.8rem;">Review Not Posted</h2>
            <p style="line-height:1.8; font-size:1.15rem; white-space:pre-wrap;">${data.warning}</p>
            <button onclick="this.closest('div').parentElement.remove()" style="margin-top:30px; background:#d4af37; color:#000; border:none; padding:12px 35px; border-radius:30px; font-weight:bold; cursor:pointer; font-size:1.1rem;">
              Close
            </button>
          </div>
        `;
        document.body.appendChild(modal);
      } else {
        alert(data.message || "Failed to submit review");
      }
      return;
    }

    successMsg.textContent = "Review submitted successfully!";
    form.reset();
    loadReviews();
    setTimeout(() => successMsg.textContent = "", 3000);

  } catch (err) {
    console.error("Submit error:", err);
    alert("Network error – check if server is running");
  }
});

// Load Reviews – with Report button added
async function loadReviews() {
  try {
    const res = await fetch(API_URL);
    const reviews = await res.json();
    box.innerHTML = reviews.map(r => {
      r.replies = r.replies || [];
      return `
      <div class="review-card" data-id="${r._id}">
        <h3>${r.name}</h3>
        <div class="review-time">${new Date(r.createdAt).toLocaleString()}</div>
        <p>${r.message}</p>
        ${r.name === currentUser 
          ? '<span class="delete-review">Delete</span>' 
          : '<span class="report-review" style="color:#ff4444; cursor:pointer; font-size:0.9rem; margin-left:10px;">Report</span>'}
        <div class="replies">
          ${r.replies.map(rep=>`
            <div class="reply-card">
              <h4>${rep.name}</h4>
              <p>${rep.message}</p>
            </div>`).join('')}
        </div>
        <form class="reply-form">
          <textarea placeholder="Write a reply..." rows="1" required></textarea>
          <button type="submit">Reply</button>
        </form>
      </div>`;
    }).join("");
  } catch(err){ console.error(err); }
}

// Submit Reply
document.addEventListener('submit', async e => {
  if(!e.target.classList.contains('reply-form')) return;
  e.preventDefault();
  const textarea = e.target.querySelector('textarea');
  const replyText = textarea.value.trim();
  if(!replyText) return;

  const reviewCard = e.target.closest('.review-card');
  const reviewId = reviewCard.dataset.id;

  try {
    const res = await fetch(`${API_URL}/${reviewId}/reply`, {
      method:"POST",
      headers: {
        "Content-Type":"application/json",
        "Authorization": `Bearer ${token}`
      },
      body:JSON.stringify({name: currentUser, message: replyText})
    });
    const data = await res.json();
    if(data.success) loadReviews();
    textarea.value = "";
  } catch(err){ console.error(err); }
});

// Delete Review
document.addEventListener('click', async e => {
  if(!e.target.classList.contains('delete-review')) return;
  const reviewCard = e.target.closest('.review-card');
  const reviewId = reviewCard.dataset.id;
  try {
    await fetch(`${API_URL}/${reviewId}`, {
      method:"DELETE",
      headers: { "Authorization": `Bearer ${token}` }
    });
    loadReviews();
  } catch(err){ console.error(err); }
});

// Report Review with success message
document.addEventListener('click', async e => {
  if (!e.target.classList.contains('report-review')) return;

  const reviewCard = e.target.closest('.review-card');
  const reviewId = reviewCard.dataset.id;
  const reviewText = reviewCard.querySelector('p').textContent.trim();
  const uploaderName = reviewCard.querySelector('h3').textContent.trim();

  if (!token) {
    alert("Please log in to report a review.");
    return;
  }

  if (!confirm(`Report this review to admin?\n\nBy: ${uploaderName}\n"${reviewText}"`)) {
    return;
  }

  try {
    const res = await fetch('http://localhost:3000/report-review', {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${token}`
      },
      body: JSON.stringify({ reviewId })
    });

    const data = await res.json();

    if (data.success) {
      // Show success message
      showTemporaryMessage(null, "✓ Report sent! Will be reviewed by admin soon.", 4000);
    } else {
      if (data.message === "You already reported this review") {
        showTemporaryMessage(null, "You already reported this review", 3000);
      } else {
        alert(data.message || "Failed to send report");
      }
    }
  } catch (err) {
    console.error("Report error:", err);
    alert("Network error – try again");
  }
});

// Tabs
tabCreate.onclick = ()=> {
  createDiv.style.display = "block";
  allDiv.style.display = "none";
  tabCreate.classList.add("active");
  tabAll.classList.remove("active");
};
tabAll.onclick = ()=> {
  createDiv.style.display = "none";
  allDiv.style.display = "block";
  tabAll.classList.add("active");
  tabCreate.classList.remove("active");
  loadReviews();
};

// Initial load
loadReviews();
</script>

</body>
</html>