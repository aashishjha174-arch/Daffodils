<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Daffodils Public School | Reviews</title>
<link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Montserrat:wght@300;600&family=Playfair+Display:italic,wght@0,700;1,400&display=swap" rel="stylesheet">
<style>
:root{
  --glass: rgba(255,255,255,0.1);
  --gold:#d4af37;
  --text:#fff;
  --nav-color:#c2f3f3;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:#000;color:var(--text);font-family:'Montserrat',sans-serif;overflow-x:hidden;}
#bg-container{position:fixed;inset:0;z-index:-2;}
.bg-slide{position:absolute;inset:-20px;background-size:cover;background-position:center;opacity:0;filter:blur(20px) brightness(0.4) saturate(1.2);transition:opacity 2s;}
.bg-slide.active{opacity:1}
#particles{position:fixed;inset:0;z-index:-1;pointer-events:none}
.particle{position:absolute;width:4px;height:4px;background:white;border-radius:50%;opacity:.4;animation:floatUp 15s infinite linear}
@keyframes floatUp{0%{transform:translateY(110vh);opacity:0}50%{opacity:.5}100%{transform:translateY(-10vh);opacity:0}}
header{text-align:center;padding:60px 20px 20px}
.title-container{display:flex;justify-content:center;gap:20px;align-items:center}
.school-name{font-family:'Playfair Display',serif;font-size:3.5rem;color:var(--gold)}
.school-logo{height:80px;border-radius:50%;filter:drop-shadow(0 0 10px rgba(212,175,55,.5))}
.nav-bar{display:flex;justify-content:center;gap:20px;flex-wrap:wrap;padding:10px 20px;background:rgba(0,0,0,.6);backdrop-filter:blur(10px);position:sticky;top:0;z-index:999}
.nav-bar a{color:var(--nav-color);text-decoration:none;font-weight:bold;padding:8px 15px;border-radius:20px;border:1px solid var(--nav-color);transition:.3s}
.nav-bar a:hover{background:var(--nav-color);color:#000}
main{max-width:1200px;margin:40px auto;padding:20px;text-align:center}
h2{color:var(--gold);font-family:'Playfair Display',serif;margin-bottom:15px}
.review-form{max-width:600px;margin:auto;display:flex;flex-direction:column;gap:15px}
.review-form textarea{padding:12px 15px;border-radius:20px;border:1px solid rgba(255,255,255,.2);background:rgba(0,0,0,.6);color:white;outline:none}
.review-form button{background:var(--gold);border:none;padding:12px;border-radius:30px;cursor:pointer;font-weight:bold}
#reviews{margin-top:40px;display:grid;gap:20px;text-align:left}
.review-card{background:var(--glass);border:1px solid rgba(255,255,255,.15);border-radius:20px;padding:20px;position:relative;backdrop-filter:blur(10px)}
.review-card h3{color:var(--gold);margin-bottom:5px}
.review-time{font-size:.8rem;opacity:.7;margin-bottom:10px}
.delete-review{position:absolute;top:15px;right:20px;cursor:pointer;font-size:1rem;opacity:.7}
.delete-review:hover{opacity:1}
.replies{margin-top:15px;padding-left:20px;border-left:1px solid rgba(255,255,255,.2)}
.reply-card{margin-bottom:10px}
.reply-card h4{color:var(--gold);font-size:.9rem;margin-bottom:3px}
.reply-card p{margin:0;font-size:.9rem}
.reply-form{display:flex;gap:10px;margin-top:5px}
.reply-form textarea{flex:1;border-radius:15px;padding:5px;font-size:.9rem}
.reply-form button{padding:5px 10px;border-radius:15px;background:var(--gold);border:none;color:#000;cursor:pointer;font-weight:bold}
#tab-buttons{display:flex;justify-content:center;gap:20px;margin-bottom:20px}
#tab-buttons button{padding:10px 20px;cursor:pointer;background:rgba(255,255,255,0.1);border:none;color:white;border-radius:20px;transition:.3s}
#tab-buttons button.active{background:var(--gold);color:#000}
.success-message{color:limegreen;text-align:center;margin-top:10px}
</style>
</head>
<body>

<div id="bg-container"></div>
<div id="particles"></div>

<header>
  <div class="title-container">
    <h1 class="school-name">DAFFODILS PUBLIC SCHOOL</h1>
    <img src="images/logo.jpeg" class="school-logo">
  </div>
  <p style="letter-spacing:5px;opacity:.8">THE FINAL FAREWELL â€¢ BATCH 2082</p>
</header>

<div class="nav-bar">
  <a href="student.html">Batch Members</a>
  <a href="dashboard.html">Dashboard</a>
  <a href="review.html">Review</a>
  <a href="ourmemories.html">Our Memories</a>
</div>

<main>
  <h2>Reviews</h2>

  <div id="tab-buttons">
    <button id="tab-create" class="active">Create Review</button>
    <button id="tab-all">All Reviews</button>
  </div>

  <div id="tab-content">
    <div id="create-review">
      <form class="review-form" id="reviewForm">
        <textarea placeholder="Write your review..." rows="5" required></textarea>
        <button type="submit">Submit Review</button>
      </form>
      <div id="successMsg" class="success-message"></div>
    </div>

    <div id="all-reviews" style="display:none;">
      <div id="reviews"></div>
    </div>
  </div>
</main>

<script>
const API_URL = "https://review-backend.onrender.com/reviews"; // change to your Render URL
const form = document.getElementById("reviewForm");
const box = document.getElementById("reviews");
const tabCreate = document.getElementById("tab-create");
const tabAll = document.getElementById("tab-all");
const createDiv = document.getElementById("create-review");
const allDiv = document.getElementById("all-reviews");
const currentUser = localStorage.getItem('currentUser') || "Guest";
const successMsg = document.getElementById("successMsg");

// Submit Review
form.addEventListener("submit", async e => {
  e.preventDefault();
  const message = form.querySelector("textarea").value.trim();
  if(!message) return;
  try {
    const res = await fetch(API_URL, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({name: currentUser, message})
    });
    const data = await res.json();
    if(data.success){
      successMsg.textContent = "Review submitted!";
      form.reset();
      loadReviews();
      setTimeout(()=> successMsg.textContent = "", 3000);
    }
  } catch(err){ console.error(err); }
});

// Load Reviews
async function loadReviews() {
  try {
    const res = await fetch(API_URL);
    const reviews = await res.json();
    box.innerHTML = reviews.map(r => {
      r.replies = r.replies || [];
      return `
      <div class="review-card" data-id="${r._id}">
        <h3>${r.name}</h3>
        <div class="review-time">${new Date(r.createdAt).toLocaleString()}</div>
        <p>${r.message}</p>
        ${r.name === currentUser ? '<span class="delete-review">Delete</span>' : ''}
        <div class="replies">
          ${r.replies.map(rep=>`
            <div class="reply-card">
              <h4>${rep.name}</h4>
              <p>${rep.message}</p>
            </div>`).join('')}
        </div>
        <form class="reply-form">
          <textarea placeholder="Write a reply..." rows="1" required></textarea>
          <button type="submit">Reply</button>
        </form>
      </div>`;
    }).join("");
  } catch(err){ console.error(err); }
}

// Handle Replies
document.addEventListener('submit', async e => {
  if(!e.target.classList.contains('reply-form')) return;
  e.preventDefault();
  const textarea = e.target.querySelector('textarea');
  const replyText = textarea.value.trim();
  if(!replyText) return;

  const reviewCard = e.target.closest('.review-card');
  const reviewId = reviewCard.dataset.id;

  try {
    const res = await fetch(`${API_URL}/${reviewId}/reply`, {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({name: currentUser, message: replyText})
    });
    const data = await res.json();
    if(data.success) loadReviews();
    textarea.value = "";
  } catch(err){ console.error(err); }
});

// Handle Delete
document.addEventListener('click', async e => {
  if(!e.target.classList.contains('delete-review')) return;
  const reviewCard = e.target.closest('.review-card');
  const reviewId = reviewCard.dataset.id;
  try {
    await fetch(`${API_URL}/${reviewId}`, {method:"DELETE"});
    loadReviews();
  } catch(err){ console.error(err); }
});

// Tabs
tabCreate.onclick = ()=> {
  createDiv.style.display = "block";
  allDiv.style.display = "none";
  tabCreate.classList.add("active");
  tabAll.classList.remove("active");
};
tabAll.onclick = ()=> {
  createDiv.style.display = "none";
  allDiv.style.display = "block";
  tabAll.classList.add("active");
  tabCreate.classList.remove("active");
  loadReviews();
};

// Load reviews on page load
loadReviews();
</script>

</body>
</html>
